\chapter{Пакетный менеджер}\label{package-manager}
Операционная система состоит из разнообразных программ, библиотек, скриптов и приложений --- число компонент может достигать тысячи единиц. В каждой из которых могут быть включены десятки файлов. Для удобства работы пользователя системные компоненты в \Sys{Linux} представлены в виде пакетов \footnote{\href{https://docs.altlinux.org/books/altlibrary-linuxintro2.pdf}{Курячий Г., Маслинский К. (2010). Операционная система Linux. Курс лекций. ДМК Пресс.}}. Пакет объединяет в общий архив все файлы, используемые программой. Пользователь подбирает программы --- устанавливает, обновляет, проверяет, удаляет их --- только по имени пакета, не вдаваясь в отдельные детали подбора всех необходимых файлов. Работа с пакетом, как единым целым, позволяет управлять всеми данными программы.

\textbf{Пакет} --- это специально подготовленный архив, содержащий программы, конфигурационные файлы, данные и управляющую информацию. Метаданные пакета содержат полное имя, номер версии, описание пакета, имя разработчика, контрольную сумму, зависимости от других пакетов. Управляющая информация пакета содержит контрольные суммы устанавливаемых файлов, зависимости устанавливаемого пакета от других пакетов, краткое описание, сценарии установки и удаления пакета, и прочую информацию, которую использует менеджер пакетов. Пакеты хранятся в специальном хранилище --- \textbf{репозитории пакетов}.

Для удобства работы с пакетами придумали собственные форматы архивов:

\begin{itemize}
	\item \Sys{RPM (.rpm)}. Разработан компанией \Sys{Red Hat}. Применяется в системе \Sys{Альт}, \Sys{Ред ОС}, \Sys{RHEL} и \Sys{CentOS}.
	\item \Sys{DEB (.deb)}. Формат пакетов дистрибутива \Sys{Debian}, а также \Sys{Ubuntu}.
	\item \Sys{TAR.XZ}. Применяется в дистрибутивах \Sys{ArchLinux} и \Sys{Manjaro}.
	
\end{itemize}

Каждый пакет определяется архитектурой системы (под которую он собран), именем программы, номером ее версии и номером релиза этой программы в дистрибутиве. 

Например, \Sys{admc-0.15.0-alt1.x86\_64.rpm}:

\begin{table}[H]
	\begin{center}
		\begin{tabular}{ll}
			Имя: & \Sys{admc} \\
			Номер версии: & \Sys{0.15.0}\\
			Номер релиза: & \textbf{alt1}\\
			Архитектура: &  \Sys{x86\_64}\\
		\end{tabular}
	\end{center}
\end{table}

\textbf{Пакетный менеджер} --- это программа для управления установкой, удалением, настройкой и обновлением пакетов с различным программным обеспечением. Пакетные менеджеры упрощают для пользователя процесс управления программами в системе. Пакетный менеджер также ведет учет пакетов, установленных в системе. Существует также менеджер зависимостей --- специальная программа, подбирающая пакеты, зависимые друг от друга, и загружающая эти пакеты из хранилища\footnote{\href{https://static-sl.insales.ru/files/1/3828/14544628/original/B-BHV-6630_part.pdf}{Кетов Д. (2021). Внутреннее устройство Linux. 2-е изд,. перераб. и доп. БХВ-Петербург.}}. Менеджер зависимостей подбирает правильные версии пакетов и определяет порядок их установки. При помощи менеджера зависимостей можно узнать, с каким пакетом поставляется тот или иной файл.

Задачи пакетного менеджера:

\begin{itemize}
	\item \textbf{установка программ}. Позволяет устанавливать программы из центрального хранилища или из локальных источников;
	\item \textbf{обновление программ}. Позволяет обновлять установленные программы до последних версий, представленных в хранилище;
	\item \textbf{удаление программ}. Позволяет безопасно удалять программы и все связанные с ними файлы;
	\item \textbf{управление зависимостями}. Автоматически устанавливает и управляет зависимостями программ;
	\item \textbf{проверка целостности пакетов}. Предотвращает конфликты при установке новых программ, обеспечивая целостность. системы.
\end{itemize}

Пакетный менеджер позволяет:

\begin{itemize}
	\item узнать информацию о пакете;
	\item определить пакет, которому принадлежит установленная программа;
	\item определить список компонент, установленных из указанного пакета.
\end{itemize}

Пакетные менеджеры делятся на две категории --- низкоуровневые и высокоуровневые.

\begin{itemize}
	\item \textbf{Низкоуровневые пакетные менеджеры}. Используются для установки локальных пакетов, загруженных вручную пользователем, или высокоуровневым пакетным менеджером.
	\item \textbf{Высокоуровневые менеджеры}. Применяются для поиска и скачивания пакетов из репозиториев. В процессе работы могут задействовать низкоуровневые менеджеры для установки загруженных программ.
\end{itemize}

В операционной системе \Sys{Альт} используется формат пакетов \Sys{.rpm}. Пакеты \Sys{rpm} хранятся в удаленном хранилище под названием \Sys{Sisyphus}. Для работы с такими пакетами применяется низкоуровневый пакетный менеджер \Sys{RPM} и консольная утилита \Sys{APT} (Advanced Packaging Tool). 

\section{Основной пакетный менеджер в Альт Платформа}
В дистрибутивах \Sys{Альт} применяется пакетный менеджер \Sys{RPM}. \Sys{RPM Package Manager} --- это семейство пакетных менеджеров, применяемых в различных дистрибутивах \Sys{GNU/Linux}. Практически каждый крупный проект, использующий \Sys{RPM}, имеет свою версию пакетного менеджера, отличающуюся от остальных.

Различия между представителями семейства \Sys{RPM} выражаются в:

\begin{itemize}
	\item наборе макросов, используемых в \Sys{.spec-файлах};
	\item различии сборки \Sys{rpm}-пакетов <<по умолчанию>> --- при отсутствии каких-либо указаний в \Sys{.spec}-файлах, формате строк зависимостей;
	\item отличиях в семантике операций (например, в операциях сравнения версий пакетов);
	\item отличиях в формате файлов.
\end{itemize}

Для пользователя различия чаще всего заключаются в невозможности поставить пакет постороннего формата (например, \Sys{.deb}) из-за проблем с зависимостями другого формата пакета. 

\section{Система управления пакетами}
Системой управления пакетами в дистрибутивах Альт является программа \Sys{APT} --- Advanced Packaging Tool (усовершенствованный инструмент работы с пакетами). Программа \Sys{APT} способна автоматически устанавливать и настраивать программы в операционных системах Альт из предварительно откомпилированных пакетов и из исходных кодов. Утилита загружает пакеты из хранилища (репозитория), либо устанавливает с локального хранилища. Список источников пакетов хранится в файле \Sys{/etc/apt/sources.list} и в каталоге \Sys{/etc/apt/sources.list.d/}. В системе \Sys{Альт} применяется графическая оболочка для \Sys{apt} --- программа \Sys{Synaptic}. Утилита \Sys{apt} значительно упрощает процесс установки программ в командном режиме.

Команда \Sys{\$ apt-get} выведет описание и возможности утилиты \Sys{apt-get}:
\begin{verbatim}
	$ apt-get
	apt 0.5.15lorg2 для linux x86_64 собран Jul 26 2023 18:10:41
	Использование: apt-get [параметры] команда
	apt-get [параметры] install|remove пакет1 [пакет2 ...]
	apt-get [параметры] source пакет1 [пакет2 ...]
	
	apt-get предоставляет простой командный интерфейс для получения и
	установки пакетов. Чаще других используются команды update (обновить)
	и install (установить).
	
	Команды:
	update - Получить обновлённые списки пакетов
	upgrade - Произвести обновление
	install - Установить новые пакеты
	remove - Удалить пакеты
	source - Скачать архивы исходников
	build-dep - Установить всё необходимое для сборки исходных пакетов
	dist-upgrade - Обновление системы в целом, см. apt-get(8)
	clean - Удалить скачанные ранее архивные файлы
	autoclean - Удалить давно скачанные архивные файлы
	check - Удостовериться в отсутствии неудовлетворённых зависимостей
	dedup - Remove unallowed duplicated pkgs
	
	Параметры:
	-h  Краткая справка
	-q  Скрыть индикатор процесса
	-qq Не показывать ничего кроме сообщений об ошибках
	-d  Получить пакеты и выйти БЕЗ их установки или распаковки
	-s  Симулировать упорядочение вместо реального исполнения
	-y  Автоматически отвечать 'ДА' на все вопросы
	-f  Пытаться исправить положение если найдены неудовлетворённые зависимости
	-m  Пытаться продолжить если часть архивов недоступна
	-u  Показать список обновляемых пакетов
	-b  Собрать пакет после получения его исходника
	-D  При удалении пакета стремиться удалить компоненты, от которых он зависит
	-V  Подробно показывать номера версий
	-c=? Использовать указанный файл конфигурации
	-o=? Изменить любой из параметров настройки (например: -o dir::cache=/tmp)
	Более полное описание доступно на страницах руководства man:
	apt-get(8), sources.list(5) и apt.conf(5).
\end{verbatim}

В ОС \Sys{Альт} утилита \Sys{apt-get} использует основной пакетный менеджер \Sys{RPM Package Manager} --- \Sys{RPM} для установки, обновления, удаления пакетов (программ), управления зависимостями. Обе утилиты \Sys{RPM} и \Sys{APT} одинаково позволяют установить, обновить или удалить пакет.

Отличия \Sys{RPM} и \Sys{APT}:
\begin{itemize}
	\item \Sys{APT} учитывает зависимости устанавливаемого пакета;
	\item \Sys{APT} умеет работать с репозиторием в целом:
	\begin{itemize}
		\item искать пакеты;
		\item вычислять список обновлений --- находить разницу версий пакетов, установленных локально и хранящихся в репозитории;
	\end{itemize}
	\item \Sys{APT} получает информацию из пакетов, используя \Sys{RPM}.
\end{itemize}

\Sys{RPM} подразумевает работу с конкретными пакетами. Удовлетворение их зависимостей остаётся на усмотрении пользователя. \Sys{APT} позволяет вычислять, какие пакеты из репозитория нужно установить, чтобы удовлетворить зависимости, которые указаны в каждом конкретном \Sys{RPM} пакете. \Sys{APT} сам не устанавливает пакеты, он использует для этого \Sys{RPM}.

\noindent 
	\begin{minipage}[b]{0.25\textwidth}
		\vspace{1cm}
		\textit{Примечание:}
	\end{minipage}
	\hspace{0.05\textwidth}
	\begin{minipage}{0.7\textwidth}
		Установка пакетов в Альт Линукс происходит с помощью утилиты \Sys{APT}
	\end{minipage}
	\vspace{0.6cm}
	
\textbf{Репозиторий} --- актуализируемое хранилище электронных данных.
В данном документе речь идет о репозитории как об инфраструктуре разработки операционных систем, включающих, помимо системного ПО, любые программы пользовательского и серверного назначения (<<репозиторий пакетов>>). Основная задача репозиториев этого рода --- интеграция разных пакетов программ в единую систему. Объектом хранения в таких репозиториях выступают пакеты программ, где каждое наименование ПО (будь то ядро операционной системы, служебная библиотека, текстовый редактор, сервер для обслуживания электронных сообщений или медиа проигрыватель) представлено в виде отдельного пакета. В операционных системах \Sys{ALT} репозиторий пакетов носит название \Sys{Sisyphus}.

\textbf{Репозиторий пакетов} --- это множество исходных пакетов, собранных из них бинарных пакетов, и мета информация об этих пакетах.

Наличие репозитория пакетов и \Sys{APT} автоматизирует процессы управления установкой, обновления и удаления программного обеспечения; исключают риск случайного повреждения целостности операционной системы и прикладных программ.

Программа \Sys{APT} по запросу пользователя получает метаданные из репозитория, рассчитывает зависимости, получает от пользователя информацию о том, какие именно пакеты он хочет обновить или установить. Утилита предложит пути решения --- например, загрузит новые пакеты из репозитория, установит дополнительные или обновит имеющиеся пакеты. \Sys{APT}, в зависимости от настроек, может использовать удаленный репозиторий с помощью сетевого протокола (например, \Sys{ftp}), или использовать локальный репозиторий (например, на жестком диске).

\noindent 
\begin{minipage}[b]{0.25\textwidth}
	\vspace{1cm}
	\textit{Примечание:}
\end{minipage}
\hspace{0.05\textwidth}
\begin{minipage}{0.7\textwidth}
	Для обновления практически всего программного обеспечения (за исключением ядра операционной системы) на локальном компьютере до новой версии необходимо выполнить одну команду:\\
	\Sys{apt-get update}\\
	\Sys{apt-get dist-upgrade}
\end{minipage}
\vspace{0.6cm}

При использовании \Sys{APT} и обновляемого стабильного репозитория операционная система может функционировать на компьютере годами, плавно обновляясь до новых версий без переустановки системы. 

\section{Установка необходимых пакетов для процесса сборки}
\textbf{Сборка} --- формирование пакета на основе сборочных инструкций.

Сборка программного обеспечения в \Sys{RPM} упрощает распространение, управление и обновление программного обеспечения. Упаковка программного обеспечения в пакеты \Sys{RPM}, а не обычный архив, имеет ряд преимуществ\footnote{\href{https://rpm-packaging-guide-ru.github.io/\#Why-Package-Software-with-RPM}{https://rpm-packaging-guide-ru.github.io/\#Why-Package-Software-with-RPM}}:

\begin{itemize}
	\item Пользователи могут использовать средства управления пакетами (например, \Sys{Yum} или \Sys{PackageKit}) для установки, переустановки, удаления, обновления и проверки пакетов \Sys{RPM}.
	\item Пакетный менеджер \Sys{RPM} предполагает наличие базы данных, которая с помощью специализированных утилит позволяет получать информацию о пакетах в системе.
	\item Каждый пакет \Sys{RPM} содержит метаданные, описывающие компоненты пакета, версию, выпуск, размер, URL проекта, установочные инструкции и т. д.
	\item \Sys{RPM} позволяет брать оригинальные источники программного обеспечения и упаковывать их в пакеты с исходным кодом(\Sys{.src.rpm}) и бинарные пакеты(\Sys{.rpm}). В пакетах с исходным кодом хранятся оригинальные исходные данные вместе со всеми изменениями(\Sys{*.patch}), а так же сборочные инструкции(\Sys{.spec}) и дополнительная информация. В бинарных пакетах вместо исходного кода упакованы подготовленные файлы и скрипты установки, но нет сборочных инструкций. Еще существуют случаи распространения пакетов без исходного кода и бинарных данных, в таких пакетах присутствуют скрипты для скачивания и модификации файлов, необходимых для работы приложения.
	\item Для обеспечения верификации подлинности \Sys{RPM}-пакетов используется механизм электронных цифровых подписей \Sys{GPG}. Он позволяет подписать \Sys{RPM} пакет или обновить цифровую подпись: \Sys{rpm -addsign package.rpm} и \Sys{rpm -resign package.rpm}.
	\item Вы можете добавить свой пакет в \Sys{RPM} репозиторий, что позволит клиентам легко находить и устанавливать ваше программное обеспечение.
\end{itemize}

Задача сборки пакета начинается со сбора всех необходимых компонентов и завершается этапами сборки и тестирования.

Классическая сборка пакетов rpm состоит из следующих этапов\footnote{\href{https://alt-packaging-guide.github.io/}{https://alt-packaging-guide.github.io/}}:

\begin{itemize}
	\item поиск исходных данных;
	\item написание инструкций сборки;
	\item сборка пакета.
\end{itemize}

\noindent 
\begin{minipage}[b]{0.25\textwidth}
	\vspace{1cm}
	\textit{Примечание:}
\end{minipage}
\hspace{0.05\textwidth}
\begin{minipage}{0.7\textwidth}
	Для сокращения команд, встречающихся в тексте, будет использоваться нотация:\\
	%\begin{itemize}
		--- команды \textbf{без административных привилегий} начинаются с символа \textbf{"\$"};\\
		--- команды \textbf{с административными привилегиями} начинаются с символа \textbf{"\#"}.
	%\end{itemize}
\end{minipage}
\vspace{0.6cm}

\noindent 
\begin{minipage}[b]{0.25\textwidth}
	\vspace{1cm}
	\textit{Примечание:}
\end{minipage}
\hspace{0.05\textwidth}
\begin{minipage}{0.7\textwidth}
	Необходимые инструменты для сборки \Sys{rpm}-пакетов устанавливаются в системе через пакетный менеджер \Sys{apt} командой:\\
	\Sys{\# apt-get install gcc rpm-build rpmlint make python gear hasher patch rpmdevtools}
\end{minipage}
\vspace{0.6cm}

В наборе параметров команды \Sys{install} перечислены имена пакетов, необходимых для сборочной инфраструктуры \footnote{\href{https://www.altlinux.org/Технология_сборки_пакетов_RPM}{https://www.altlinux.org/Технология\_сборки\_пакетов\_RPM}}:

\begin{itemize}
	\item \Sys{gcc} --- набор компиляторов для различных языков программирования, разработанный в рамках проекта GNU;
	\item \Sys{rpm-build} --- содержит сценарии и исполняемые программы, которые используются для сборки пакетов с помощью \Sys{RPM};
	\item \Sys{rpmlint} --- инструмент для проверки распространенных ошибок в пакетах \Sys{rpm}. Можно проверить бинарные и исходные пакеты;
	\item \Sys{make} --- инструмент GNU, упрощающий процесс сборки для пользователей;
	\item \Sys{python} --- интерпретируемый интерактивный объектно-ориентированный язык программирования;
	\item \Sys{gear} --- этот пакет содержит утилиты для сборки пакетов \Sys{RPM} из \Sys{GEAR}.репозитория и управления \Sys{GEAR}.репозиториями;
	\item \Sys{hasher} --- современная технология создания независимых от сборочной системы пакетов;
	\item \Sys{patch} --- программа исправлений применяет патчи к оригиналам;
	\item \Sys{rpmdevtools} --- пакет содержит скрипты и файлы поддерживающие \Sys{(X)Emacs}, помогающие в разработке пакетов \Sys{RPM}.
	\end{itemize}


